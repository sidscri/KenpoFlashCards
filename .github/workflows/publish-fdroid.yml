name: Build + Sign + Publish F-Droid Repo (GitHub Pages)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    env:
      GRADLE_USER_HOME: ${{ github.workspace }}/.gradle

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Decode keystore (JKS)
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | tr -d '\n' | base64 -d > release.keystore
          ls -la release.keystore
          keytool -list -keystore release.keystore -storetype JKS -storepass "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >/dev/null
          echo "Keystore opens OK."

      # Workaround for "Permission denied" executing Gradle distribution downloaded by the wrapper.
      - name: Build release APK (no-wrapper exec workaround)
        run: |
          WRAPPER_PROPS="KenpoFlashcardsProject-v2/gradle/wrapper/gradle-wrapper.properties"
          if [ ! -f "$WRAPPER_PROPS" ]; then
            echo "Missing $WRAPPER_PROPS"
            ls -la KenpoFlashcardsProject-v2/gradle/wrapper || true
            exit 1
          fi

          DIST_URL=$(grep -E '^distributionUrl=' "$WRAPPER_PROPS" | cut -d= -f2-)
          DIST_URL=$(echo "$DIST_URL" | sed 's#\\##g')
          echo "Gradle distribution URL: $DIST_URL"

          mkdir -p /tmp/gradle_dist
          curl -L "$DIST_URL" -o /tmp/gradle_dist/gradle.zip
          unzip -q /tmp/gradle_dist/gradle.zip -d /tmp/gradle_dist

          GRADLE_HOME=$(find /tmp/gradle_dist -maxdepth 1 -type d -name "gradle-*" | head -n 1)
          if [ -z "$GRADLE_HOME" ]; then
            echo "Could not find extracted gradle-* folder"
            ls -la /tmp/gradle_dist
            exit 1
          fi

          echo "Using GRADLE_HOME=$GRADLE_HOME"
          bash "$GRADLE_HOME/bin/gradle" -p KenpoFlashcardsProject-v2 assembleRelease

      - name: Find APK to sign
        working-directory: KenpoFlashcardsProject-v2
        run: |
          echo "APK outputs (release):"
          find app/build/outputs/apk/release -type f -name "*.apk" -print

          APK_IN=$(find app/build/outputs/apk/release -type f -name "*unsigned*.apk" | head -n 1)
          if [ -z "$APK_IN" ]; then
            APK_IN=$(find app/build/outputs/apk/release -type f -name "*.apk" | head -n 1)
          fi

          if [ -z "$APK_IN" ]; then
            echo "No APK found!"
            exit 1
          fi

          echo "Will sign: $APK_IN"
          echo "APK_IN=$APK_IN" >> $GITHUB_ENV

      - name: Sign APK (apksigner)
        working-directory: KenpoFlashcardsProject-v2
        run: |
          BUILD_TOOLS=$(ls "$ANDROID_SDK_ROOT/build-tools" | sort -V | tail -n 1)
          APKSIGNER="$ANDROID_SDK_ROOT/build-tools/$BUILD_TOOLS/apksigner"
          echo "Using build-tools: $BUILD_TOOLS"
          echo "Using apksigner: $APKSIGNER"
          echo "Input APK: $APK_IN"

          APK_OUT="../app-release.apk"

          "$APKSIGNER" sign             --ks ../release.keystore             --ks-type JKS             --ks-key-alias "${{ secrets.ANDROID_KEY_ALIAS }}"             --ks-pass pass:"${{ secrets.ANDROID_KEYSTORE_PASSWORD }}"             --key-pass pass:"${{ secrets.ANDROID_KEY_PASSWORD }}"             --out "$APK_OUT"             "$APK_IN"

          "$APKSIGNER" verify "$APK_OUT"
          ls -la "$APK_OUT"

      - name: Build F-Droid repo index (signed)
        env:
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          sudo apt-get update
          sudo apt-get install -y fdroidserver

          rm -rf fdroidwork
          mkdir -p fdroidwork
          cd fdroidwork
          fdroid init

          mkdir -p repo
          cp ../app-release.apk repo/
          cp ../release.keystore keystore.jks

          cat > config.yml << EOF
          repo_url: https://sidscri.github.io/sidscri-apps/repo
          repo_name: Sidscri Apps
          repo_description: "Repo for my personal apps."
          repo_keyalias: ${ANDROID_KEY_ALIAS}
          keystore: keystore.jks
          keystorepass: ${ANDROID_KEYSTORE_PASSWORD}
          keypass: ${ANDROID_KEY_PASSWORD}
          EOF

          fdroid update --create-metadata || true
          fdroid update
          ls -la repo

      - name: Prepare Pages content
        run: |
          rm -rf public
          mkdir -p public
          cp -r fdroidwork/repo public/repo

          cat > public/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="utf-8">
              <meta name="viewport" content="width=device-width, initial-scale=1">
              <title>Sidscri Apps - F-Droid Repo</title>
              <style>
                  * { box-sizing: border-box; }
                  body {
                      font-family: system-ui, -apple-system, sans-serif;
                      max-width: 600px;
                      margin: 0 auto;
                      padding: 20px;
                      background: #0f1217;
                      color: #eaeef7;
                      line-height: 1.6;
                  }
                  h1 { color: #fff; margin-bottom: 8px; }
                  .subtitle { color: #b7c0d4; margin-bottom: 24px; }
                  .card {
                      background: #151a22;
                      border: 1px solid #2b3140;
                      border-radius: 12px;
                      padding: 20px;
                      margin-bottom: 16px;
                  }
                  .qr-container {
                      text-align: center;
                      padding: 20px;
                  }
                  .qr-container img {
                      background: white;
                      padding: 12px;
                      border-radius: 8px;
                  }
                  .repo-url {
                      background: #11161f;
                      padding: 12px;
                      border-radius: 8px;
                      font-family: monospace;
                      word-break: break-all;
                      margin: 12px 0;
                  }
                  .copy-btn {
                      background: #1f6feb;
                      color: white;
                      border: none;
                      padding: 10px 20px;
                      border-radius: 6px;
                      cursor: pointer;
                      font-size: 14px;
                  }
                  .copy-btn:hover { background: #1a5fd4; }
                  .steps { color: #b7c0d4; }
                  .steps li { margin-bottom: 8px; }
                  .app-item {
                      display: flex;
                      align-items: center;
                      gap: 12px;
                      padding: 12px;
                      background: #11161f;
                      border-radius: 8px;
                      margin-top: 12px;
                  }
                  .app-icon {
                      width: 48px;
                      height: 48px;
                      background: #1f6feb;
                      border-radius: 10px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      font-size: 24px;
                  }
                  .app-info h3 { margin: 0; font-size: 16px; }
                  .app-info p { margin: 4px 0 0 0; font-size: 13px; color: #b7c0d4; }
              </style>
          </head>
          <body>
              <h1>ðŸ¥‹ Sidscri Apps</h1>
              <p class="subtitle">Personal F-Droid Repository</p>

              <div class="card">
                  <h2>ðŸ“± Add to F-Droid</h2>
                  <p>Scan this QR code with F-Droid to add the repository:</p>
                  
                  <div class="qr-container">
                      <img src="https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=https%3A%2F%2Fsidscri.github.io%2Fsidscri-apps%2Frepo&choe=UTF-8" alt="QR Code for F-Droid Repo">
                  </div>

                  <p>Or copy the repository URL:</p>
                  <div class="repo-url" id="repoUrl">https://sidscri.github.io/sidscri-apps/repo</div>
                  <button class="copy-btn" onclick="copyUrl()">ðŸ“‹ Copy URL</button>
              </div>

              <div class="card">
                  <h2>ðŸ“‹ How to Add</h2>
                  <ol class="steps">
                      <li>Open <strong>F-Droid</strong> on your Android device</li>
                      <li>Go to <strong>Settings</strong> â†’ <strong>Repositories</strong></li>
                      <li>Tap <strong>+</strong> to add a new repository</li>
                      <li>Scan the QR code above, or paste the URL</li>
                      <li>Tap <strong>Add</strong> to confirm</li>
                      <li>Pull down to refresh, then search for the app</li>
                  </ol>
              </div>

              <div class="card">
                  <h2>ðŸ“¦ Available Apps</h2>
                  <div class="app-item">
                      <div class="app-icon">ðŸ¥‹</div>
                      <div class="app-info">
                          <h3>Kenpo Flashcards</h3>
                          <p>Study martial arts terminology with flashcards. Features include term breakdowns, progress tracking, and text-to-speech.</p>
                      </div>
                  </div>
              </div>

              <script>
                  function copyUrl() {
                      const url = document.getElementById('repoUrl').textContent;
                      navigator.clipboard.writeText(url).then(() => {
                          const btn = document.querySelector('.copy-btn');
                          btn.textContent = 'âœ“ Copied!';
                          setTimeout(() => btn.textContent = 'ðŸ“‹ Copy URL', 2000);
                      });
                  }
              </script>
          </body>
          </html>
          HTMLEOF

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
