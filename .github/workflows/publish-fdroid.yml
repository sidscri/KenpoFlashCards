name: Build + Sign + Publish F-Droid Repo (GitHub Pages)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    env:
      # Keep Gradle caches inside the workspace to avoid permission/exec-bit weirdness in ~/.gradle
      GRADLE_USER_HOME: ${{ github.workspace }}/.gradle

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Decode keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | tr -d '\n' | base64 -d > release.jks
          ls -la release.jks

      - name: Make gradlew executable
        run: chmod +x KenpoFlashcardsProject/gradlew

      - name: Fix Gradle wrapper cache permissions
        run: |
          chmod +x KenpoFlashcardsProject/gradlew
          chmod -R +x "$GRADLE_USER_HOME/wrapper/dists" || true
          find "$GRADLE_USER_HOME/wrapper/dists" -type f -name gradle -exec chmod +x {} \; || true
          find "$GRADLE_USER_HOME/wrapper/dists" -type f -name "*.sh" -exec chmod +x {} \; || true

      - name: Build release APK
        working-directory: KenpoFlashcardsProject
        run: ./gradlew assembleRelease

      - name: Find APK to sign
        working-directory: KenpoFlashcardsProject
        run: |
          echo "APK outputs:"
          find app/build/outputs/apk/release -type f -name "*.apk" -print

          APK_IN=$(find app/build/outputs/apk/release -type f -name "*unsigned*.apk" | head -n 1)
          if [ -z "$APK_IN" ]; then
            APK_IN=$(find app/build/outputs/apk/release -type f -name "*.apk" | head -n 1)
          fi

          if [ -z "$APK_IN" ]; then
            echo "No APK found!"
            exit 1
          fi

          echo "APK_IN=$APK_IN" >> $GITHUB_ENV

      - name: Sign APK (apksigner)
        working-directory: KenpoFlashcardsProject
        run: |
          # Auto-detect build-tools version
          BUILD_TOOLS=$(ls "$ANDROID_SDK_ROOT/build-tools" | sort -V | tail -n 1)
          APKSIGNER="$ANDROID_SDK_ROOT/build-tools/$BUILD_TOOLS/apksigner"
          echo "Using build-tools: $BUILD_TOOLS"
          echo "Using apksigner: $APKSIGNER"

          APK_OUT="../app-release.apk"

          "$APKSIGNER" sign             --ks ../release.jks             --ks-key-alias "${{ secrets.ANDROID_KEY_ALIAS }}"             --ks-pass pass:"${{ secrets.ANDROID_KEYSTORE_PASSWORD }}"             --key-pass pass:"${{ secrets.ANDROID_KEY_PASSWORD }}"             --out "$APK_OUT"             "$APK_IN"

          "$APKSIGNER" verify "$APK_OUT"
          ls -la "$APK_OUT"

      - name: Build F-Droid repo index
        run: |
          sudo apt-get update
          sudo apt-get install -y fdroidserver

          mkdir -p fdroid/repo
          cp app-release.apk fdroid/repo/

          cat > fdroid/config.yml << 'EOF'
          repo_url: https://sidscri.github.io/KenpoFlashCards/repo
          repo_name: Sidscri Apps
          repo_description: "Private repo for my personal apps."
          EOF

          cd fdroid
          fdroid init || true
          fdroid update --create-metadata || true
          fdroid update
          ls -la repo

      - name: Publish to GitHub Pages (gh-pages branch)
        run: |
          rm -rf public
          mkdir -p public
          cp -r fdroid/repo public/repo

          cat > public/index.html << 'EOF'
          <html>
            <head><meta charset="utf-8"><title>Sidscri Apps Repo</title></head>
            <body>
              <h1>Sidscri Apps Repo</h1>
              <p>Add this repo in F-Droid:</p>
              <pre>https://sidscri.github.io/KenpoFlashCards/repo</pre>
            </body>
          </html>
          EOF

          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"

          git checkout --orphan gh-pages
          git rm -rf . || true
          cp -r public/* .
          git add .
          git commit -m "Publish F-Droid repo"
          git push -f origin gh-pages
