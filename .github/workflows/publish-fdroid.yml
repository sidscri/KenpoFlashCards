name: Build + Sign + Publish F-Droid Repo (GitHub Pages)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    env:
      GRADLE_USER_HOME: ${{ github.workspace }}/.gradle

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Decode keystore
        run: |
          # ANDROID_KEYSTORE_BASE64 must be raw base64 of keystore bytes (no BEGIN/END lines)
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | tr -d '\n' | base64 -d > release.keystore
          ls -la release.keystore

      - name: Detect keystore type (JKS vs PKCS12) and verify
        run: |
          set -e
          KSTORE="release.keystore"

          # Try JKS first
          if keytool -list -keystore "$KSTORE" -storetype JKS -storepass "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >/dev/null 2>&1; then
            echo "KS_TYPE=JKS" >> $GITHUB_ENV
            echo "Keystore type detected: JKS"
            exit 0
          fi

          # Then PKCS12
          if keytool -list -keystore "$KSTORE" -storetype PKCS12 -storepass "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >/dev/null 2>&1; then
            echo "KS_TYPE=PKCS12" >> $GITHUB_ENV
            echo "Keystore type detected: PKCS12"
            exit 0
          fi

          echo "ERROR: Could not open keystore as JKS or PKCS12 (wrong base64 or password)."
          exit 1

      - name: Build release APK (no-wrapper exec workaround)
        run: |
          WRAPPER_PROPS="KenpoFlashcardsProject/gradle/wrapper/gradle-wrapper.properties"
          if [ ! -f "$WRAPPER_PROPS" ]; then
            echo "Missing $WRAPPER_PROPS"
            ls -la KenpoFlashcardsProject/gradle/wrapper || true
            exit 1
          fi

          DIST_URL=$(grep -E '^distributionUrl=' "$WRAPPER_PROPS" | cut -d= -f2-)
          DIST_URL=$(echo "$DIST_URL" | sed 's#\\##g')

          echo "Gradle distribution URL: $DIST_URL"

          mkdir -p /tmp/gradle_dist
          curl -L "$DIST_URL" -o /tmp/gradle_dist/gradle.zip
          unzip -q /tmp/gradle_dist/gradle.zip -d /tmp/gradle_dist

          GRADLE_HOME=$(find /tmp/gradle_dist -maxdepth 1 -type d -name "gradle-*" | head -n 1)
          if [ -z "$GRADLE_HOME" ]; then
            echo "Could not find extracted gradle-* folder"
            ls -la /tmp/gradle_dist
            exit 1
          fi

          echo "Using GRADLE_HOME=$GRADLE_HOME"
          bash "$GRADLE_HOME/bin/gradle" -p KenpoFlashcardsProject assembleRelease

      - name: Find APK to sign
        working-directory: KenpoFlashcardsProject
        run: |
          echo "APK outputs:"
          find app/build/outputs/apk/release -type f -name "*.apk" -print

          APK_IN=$(find app/build/outputs/apk/release -type f -name "*unsigned*.apk" | head -n 1)
          if [ -z "$APK_IN" ]; then
            APK_IN=$(find app/build/outputs/apk/release -type f -name "*.apk" | head -n 1)
          fi

          if [ -z "$APK_IN" ]; then
            echo "No APK found!"
            exit 1
          fi

          echo "APK_IN=$APK_IN" >> $GITHUB_ENV

      - name: Sign APK (apksigner)
        working-directory: KenpoFlashcardsProject
        run: |
          BUILD_TOOLS=$(ls "$ANDROID_SDK_ROOT/build-tools" | sort -V | tail -n 1)
          APKSIGNER="$ANDROID_SDK_ROOT/build-tools/$BUILD_TOOLS/apksigner"
          echo "Using build-tools: $BUILD_TOOLS"
          echo "Using apksigner: $APKSIGNER"
          echo "Using keystore type: $KS_TYPE"

          APK_OUT="../app-release.apk"

          "$APKSIGNER" sign             --ks ../release.keystore             --ks-type "$KS_TYPE"             --ks-key-alias "${{ secrets.ANDROID_KEY_ALIAS }}"             --ks-pass pass:"${{ secrets.ANDROID_KEYSTORE_PASSWORD }}"             --key-pass pass:"${{ secrets.ANDROID_KEY_PASSWORD }}"             --out "$APK_OUT"             "$APK_IN"

          "$APKSIGNER" verify "$APK_OUT"
          ls -la "$APK_OUT"

      - name: Build F-Droid repo index
        run: |
          sudo apt-get update
          sudo apt-get install -y fdroidserver

          mkdir -p fdroid/repo
          cp app-release.apk fdroid/repo/

          cat > fdroid/config.yml << 'EOF'
          repo_url: https://sidscri.github.io/KenpoFlashCards/repo
          repo_name: Sidscri Apps
          repo_description: "Private repo for my personal apps."
          EOF

          cd fdroid
          fdroid init || true
          fdroid update --create-metadata || true
          fdroid update
          ls -la repo

      - name: Publish to GitHub Pages (gh-pages branch)
        run: |
          rm -rf public
          mkdir -p public
          cp -r fdroid/repo public/repo

          cat > public/index.html << 'EOF'
          <html>
            <head><meta charset="utf-8"><title>Sidscri Apps Repo</title></head>
            <body>
              <h1>Sidscri Apps Repo</h1>
              <p>Add this repo in F-Droid:</p>
              <pre>https://sidscri.github.io/KenpoFlashCards/repo</pre>
            </body>
          </html>
          EOF

          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"

          git checkout --orphan gh-pages
          git rm -rf . || true
          cp -r public/* .
          git add .
          git commit -m "Publish F-Droid repo"
          git push -f origin gh-pages
